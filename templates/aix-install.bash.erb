#!/bin/bash -e

download_file() {
  source_file="https://<%= @master %>:8140/packages/current/<%= @platform_tag %>/${1?}"
  if hash curl >&/dev/null; then
    curl --tlsv1 -s "${source_file?}" -o "<%= @staging_dir %>/${1?}"
  else
    echo "Couldn't find curl; unable to continue" >&2
    exit 1
  fi
}

download_packages() {
  download_file "packages.txt"

  for rpm in $(cat "<%= @staging_dir %>/packages.txt"); do
    download_file "${rpm?}"
  done
}

install_agent() {

  download_packages

  rpm -U --force "<%= @staging_dir %>"/*.rpm

  /opt/puppet/bin/puppet resource service pe-puppet ensure=running enable=true
  /opt/puppet/bin/puppet resource service pe-mcollective ensure=running enable=true
}

install_agent "$@"
